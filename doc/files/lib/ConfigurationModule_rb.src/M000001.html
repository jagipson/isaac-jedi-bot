<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>configuration_from_file (lib/ConfigurationModule.rb)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>    <span class="ruby-comment cmt"># File lib/ConfigurationModule.rb, line 4</span>
 4: <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">configuration_from_file</span>(<span class="ruby-identifier">config_file</span>=<span class="ruby-constant">DEFAULT_CONF</span>)
 5:   
 6:   <span class="ruby-identifier">fatal_errors_occured</span> = <span class="ruby-keyword kw">false</span>
 7:   
 8:   <span class="ruby-keyword kw">if</span> (<span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">config_file</span>)) <span class="ruby-keyword kw">then</span>
 9:     <span class="ruby-identifier">config_root</span> = <span class="ruby-constant">YAML</span>.<span class="ruby-identifier">load_file</span>(<span class="ruby-identifier">config_file</span>)
10:     <span class="ruby-comment cmt"># ensure that yaml represented a hash</span>
11:     <span class="ruby-keyword kw">if</span> (<span class="ruby-keyword kw">not</span> <span class="ruby-identifier">config_root</span>.<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">Hash</span>)) <span class="ruby-keyword kw">then</span>
12:       <span class="ruby-identifier">fatal_errors_occured</span> = <span class="ruby-keyword kw">true</span>
13:       <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Fatal: Corrupt configuration (#{config_file})&quot;</span>
14:       <span class="ruby-identifier">exit</span> <span class="ruby-comment cmt">#immediately, really.  nothing else to examine</span>
15:     <span class="ruby-keyword kw">end</span>
16:     <span class="ruby-comment cmt"># Testing cruft:</span>
17:     <span class="ruby-comment cmt">#puts &quot;Did read config:\n#{config_root.inspect}&quot;</span>
18:   <span class="ruby-keyword kw">else</span>
19:     <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Unable to locate config #{config_file}.  Using defaults.&quot;</span>
20:     <span class="ruby-identifier">config_root</span> = {}
21:   <span class="ruby-keyword kw">end</span>  
22:   
23:   <span class="ruby-comment cmt"># Make sure initial nick is set</span>
24:   <span class="ruby-keyword kw">if</span> (<span class="ruby-keyword kw">not</span> <span class="ruby-identifier">config_root</span>[<span class="ruby-identifier">:bot_nick</span>]) <span class="ruby-keyword kw">then</span>
25:     <span class="ruby-identifier">config_root</span>[<span class="ruby-identifier">:bot_nick</span>] = <span class="ruby-node">&quot;UnnamedBot_#{(rand * 10000).to_i}&quot;</span>
26:     <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;No setting for $bot_config[:bot_nick].  Using #{config_root[:bot_nick]}&quot;</span>
27:   <span class="ruby-keyword kw">end</span>
28:   
29:   <span class="ruby-comment cmt"># Make sure owner nick is set</span>
30:   <span class="ruby-keyword kw">if</span> (<span class="ruby-keyword kw">not</span> <span class="ruby-identifier">config_root</span>[<span class="ruby-identifier">:owner_nick</span>]) <span class="ruby-keyword kw">then</span>
31:     <span class="ruby-identifier">config_root</span>[<span class="ruby-identifier">:owner_nick</span>] = <span class="ruby-constant">ENV</span>[<span class="ruby-value str">&quot;USER&quot;</span>]
32:     <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;No setting for $bot_config[:bot_nick].  Using #{config_root[:owner_nick]}&quot;</span>
33:   <span class="ruby-keyword kw">end</span>
34:    
35:   <span class="ruby-comment cmt"># Make sure required connection settings are set</span>
36:   <span class="ruby-comment cmt"># connection parameters is a hash</span>
37:   <span class="ruby-identifier">config_root</span>[<span class="ruby-identifier">:connection_parameters</span>] <span class="ruby-operator">||=</span> {}
38:   <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">config_root</span>[<span class="ruby-identifier">:connection_parameters</span>].<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">Hash</span>) <span class="ruby-keyword kw">then</span>
39:     <span class="ruby-identifier">fatal_errors_occured</span> = <span class="ruby-keyword kw">true</span>
40:     <span class="ruby-identifier">warn</span> <span class="ruby-value str">&quot;Fatal: Corrupt configuration (connection_parameters)&quot;</span>
41:   <span class="ruby-keyword kw">end</span>
42:   <span class="ruby-node">%w(server port ssl realname verbose)</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">setting</span><span class="ruby-operator">|</span>
43:     <span class="ruby-keyword kw">if</span> (<span class="ruby-keyword kw">not</span> <span class="ruby-identifier">config_root</span>[<span class="ruby-identifier">:connection_parameters</span>][<span class="ruby-identifier">setting</span>.<span class="ruby-identifier">to_sym</span>]) <span class="ruby-keyword kw">then</span>
44:       <span class="ruby-identifier">config_root</span>[<span class="ruby-identifier">:connection_parameters</span>][<span class="ruby-identifier">setting</span>.<span class="ruby-identifier">to_sym</span>] = <span class="ruby-node">&quot;#{setting}&quot;</span>
45:       <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;No #{setting} setting for $bot_config[:bot_nick]. Please check #{config_file}&quot;</span>
46:       <span class="ruby-identifier">fatal_errors_occured</span> = <span class="ruby-keyword kw">true</span>
47:     <span class="ruby-keyword kw">end</span>
48:   <span class="ruby-keyword kw">end</span>
49:   
50:   <span class="ruby-identifier">config_root</span>[<span class="ruby-identifier">:nickserv_secret</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;&quot;</span>
51:   
52:   <span class="ruby-identifier">write_configuration</span>(<span class="ruby-identifier">config_root</span>, <span class="ruby-identifier">config_file</span>)
53:   <span class="ruby-identifier">exit</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">fatal_errors_occured</span>
54:   <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">config_root</span>
55: <span class="ruby-keyword kw">end</span></pre>
</body>
</html>
